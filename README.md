# State of the fried-egg project

Any questions? Oliver's internship is over but he is happy to answer questions (oflatt@gmail.com).

Fried egg is an egraph-based optimizer for TAC programs. The kotlin code converts TAC Commands into a block format that the rust code then parses (`MathOptimization.kt`). The program is represented as a series of blocks with assignments to variables in them (see tests in `lin_inv.rs`). It outputs equalities that it learned about the program that are true globally. Right now it is very experimental, and it's not clear if it will actually help Z3 or not.

Fried egg works by first inserting the program into the egraph, running math axioms on the egraph, then extracting the program back out (`TacOptimizer::run`). In an egraph, intermediate variables are inconvenient (they make it hard to extract simpler terms back out), so we avoid them by keeping a side table of which variables correspond to eclasses in the egraph.

The math axioms are generated by our `ruler-evm` project, forked from [Ruler](https://github.com/uwplse/ruler). Ruler figures out math axioms by enumerating things in the egraph and checking if they are true using Z3.
Rules should not be written by hand if possible (instead `ruler-evm` should be extended to generate the needed rules).
See the list of axioms in `ruler-rules.json`.

The first thing the rust code does is make all the variables in each block independent.
This way, each block can be simplified independently in the e-graph.

## To-dos

- It would be great to support all types of TACExpr so that we can really send the whole program to Rust. That would allow us to do cool things like change the structure of blocks/loop optimizations.
- It would be cool to do partial evaluation / automatic inlining in the egraph when we simplify things. Though I'm not sure if it's worth the runtime cost.
Imagine we have a program:
```
Block1: x = 0

Block2: x = 2 * pi

Block3, with parents (Block1 and Block2): y = sin(x)
```
If we try inlining block1 and block2, we find that in both cases y = 0. But we will never find that the x in block1 is equal to the x in block2. (This is just an example, we don't actually support sin or real numbers.)



## Future project: Adapting to perform linear invariant inference

We would like to replace `PointerSimplification.kt` with fried-egg, since it could be much faster and find better simplifications.
The challenge is to not replace assignments that need to maintain a particular shape for other analysis.
In particular, byte array length computations are a problem. There is code that finds these computations in `AllocationAnalysis.kt`, but the PointerSimplification code does it's own ad-hoc thing using the invariants it found.

Besides detecting these cases, it should be a drop-in replacement because we first try to extract linear invariants on the rust side. Make sure to run the `EncoderAnalysisTest.kt` and the `DecoderAnalysisTest.kt`. If those pass the replacement worked.